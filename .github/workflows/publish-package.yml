name: Build and Publish NuGet Packages

on:
  workflow_dispatch:
  release:
    types: [published]

env:
  PROJECTS_TO_PUBLISH: "src/TestFusion/TestFusion.csproj src/TestFusion.BrowserTesting/TestFusion.BrowserTesting.csproj src/TestFusion.HttpTesting/TestFusion.HttpTesting.csproj src/TestFusion.MsTestAdapter/TestFusion.MsTestAdapter.csproj src/TestFusion.Sink.InfluxDB/TestFusion.Sink.InfluxDB.csproj"
  NUGET_SOURCE: "https://api.nuget.org/v3/index.json"

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Extract version from Directory.Build.props
      id: get-version
      run: |
        if [ ! -f src/Directory.Build.props ]; then
          echo "‚ùå src/Directory.Build.props not found!"
          exit 1
        fi
        VERSION=$(xmllint --xpath "string(//Project/PropertyGroup/Version)" src/Directory.Build.props)
        echo "üì¶ Version found: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Restore dependencies
      run: dotnet restore src

    - name: Build all selected projects
      run: dotnet build src --configuration Release --no-restore

    - name: Pack only selected projects
      run: |
        for proj in $PROJECTS_TO_PUBLISH; do
          dotnet pack "$proj" --configuration Release --no-build /p:Version=${{ steps.get-version.outputs.version }}
        done

    - name: Push packages to NuGet
      run: |
        for proj in $PROJECTS_TO_PUBLISH; do
          proj_dir=$(dirname "$proj")
          dotnet nuget push "$proj_dir/bin/Release/*.nupkg" --skip-duplicate --source $NUGET_SOURCE --api-key ${{ secrets.NUGET_API_KEY }}
        done

    - name: Unlist packages after publishing
      run: |
        for proj in $PROJECTS_TO_PUBLISH; do
          # Extract package ID from the .csproj file
          ID=$(xmllint --xpath "string(//Project/PropertyGroup/PackageId | //Project/PropertyGroup/AssemblyName)" "$proj")
          if [ -z "$ID" ]; then
            echo "‚ö†Ô∏è  Could not find PackageId or AssemblyName in $proj"
            continue
          fi
          VERSION=${{ steps.get-version.outputs.version }}
          echo "üîï Unlisting $ID version $VERSION..."
          curl -X POST \
            -H "X-NuGet-ApiKey: ${{ secrets.NUGET_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{}' \
            "https://www.nuget.org/api/v2/package/$ID/$VERSION"
        done
